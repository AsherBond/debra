#!/bin/sh

usage() {
	echo "Usage: $(basename $0) create|sourceinstall|build|destroy|help [...]" >&2
	if [ -n "$1" ]; then
		echo "  create <name> [<control>]" >&2
		echo "    create a directory for building debs" >&2
		echo "  sourceinstall <name> <tarball-uri> [...]" >&2
		echo "    install a source package into the directory for building debs" >&2
		echo "  build <name> <deb>" >&2
		echo "    build a deb from a directory for building debs" >&2
		echo "  destroy <name>" >&2
		echo "    remove a directory for building debs" >&2
		echo "  help" >&2
		echo "    show this help message" >&2
	fi
	exit 1
}
ACTION=$1
DIRNAME=$2
[ -z "$ACTION" ] && usage
if [ -z "$DIRNAME" ]; then
	case $ACTION in
		help) usage MOAR;;
		*) usage;;
	esac
fi
shift 2
mkdir -p $DIRNAME
DIRNAME=$(readlink -fn $DIRNAME)

case $ACTION in

	# Create a directory for building Debian packages.
	create)
		mkdir -p $DIRNAME/DEBIAN
		if [ -f "$1" ]; then
			cp $1 $DIRNAME/DEBIAN/control
		else
			if [ -f $HOME/.debra ]; then
				cp $HOME/.debra $DIRNAME/DEBIAN/control
			else
				cat >$DIRNAME/DEBIAN/control <<EOF
Package: TODO
Version: TODO
Section: TODO
Priority: optional
Essential: no
Architecture: TODO
Depends: TODO
Pre-Depends: TODO
Recommends: TODO
Suggests: TODO
Conflicts: TODO
Replaces: TODO
Provides: TODO
Installed-Size: TODO
Maintainer: TODO
Description: TODO
EOF
			fi
		fi
		cat >$DIRNAME/DEBIAN/postinst <<EOF
#!/bin/sh
exit 0
EOF
		cat >$DIRNAME/DEBIAN/prerm <<EOF
#!/bin/sh
exit 0
EOF
		chmod 755 $DIRNAME/DEBIAN/postinst $DIRNAME/DEBIAN/prerm
		;;

	# Install a source package.
	sourceinstall)
		TARBALL=$1
		[ -z "$TARBALL" ] && usage MOAR
		shift
		PACKAGE=$(basename "$TARBALL" \
			| sed -r 's/^(.+)\.(tar\.(bz2|gz)|tgz)$/\1/')
		exec $(dirname $0)/sourceinstall "$TARBALL" \
			-p /opt/$PACKAGE "$@" -d $DIRNAME
		;;

	# Build a Debian package from a directory.
	build)
		DEB=$1
		[ -z "$DEB" ] && usage MOAR
		shift

		# Fix incorrect paths (mostly in shebang lines) before running
		# `dpkg`.  Files are copied aside rather than moved to preserve
		# their permissions.
		for PATHNAME in $(grep -rlI $DIRNAME $DIRNAME); do
			cp $PATHNAME $PATHNAME.sav
			sed s/$(echo $DIRNAME | sed 's/\//\\\//g')//g \
				<$PATHNAME.sav >$PATHNAME
			rm $PATHNAME.sav
		done

		# Create DEBIAN/md5sums for inclusion in the package.
		rm -f $DIRNAME/DEBIAN/md5sums
		for PATHNAME in $(find $DIRNAME -type f -not -path $DIRNAME/DEBIAN/\*)
		do
			md5sum $PATHNAME >>$DIRNAME/DEBIAN/md5sums
		done

		exec dpkg -b $DIRNAME $DEB
		;;

	# Remove a directory.
	destroy)
		rm -rf $DIRNAME
		;;

	# Show the detailed help message.
	help)
		usage MOAR
		;;

	# Dispatch actions in external scripts or fall back to the usage message.
	*)
		[ -x $0-$ACTION ] && exec $0-$ACTION $@
		usage
		;;

esac
